version: "3"

includes:
  utils: "../tools/yscope-dev-utils/exports/taskfiles/utils/remote.yaml"

vars:
  G_HELM_TOOLCHAIN_DIR: "{{.G_BUILD_DIR}}/toolchains/helm"
  G_HELM_TOOLCHAIN_ENV_FILE: "{{.G_HELM_TOOLCHAIN_DIR}}/env"

tasks:
  helm:
    run: "once"
    vars:
      CHART_TESTING_VERSION: "3.14.0"
    cmds:
      - "mkdir -p '{{.G_HELM_TOOLCHAIN_DIR}}'"
      - task: "utils:download-and-extract-tar"
        vars:
          OUTPUT_DIR: "{{.G_BUILD_DIR}}/toolchains/helm"
          URL: "https://github.com/helm/chart-testing/releases/download/v{{.CHART_TESTING_VERSION}}\
          /chart-testing_{{.CHART_TESTING_VERSION}}_{{OS}}_{{ARCH}}.tar.gz"
          FILE_SHA256: >-
            {{- if and (eq OS "linux") (eq ARCH "amd64") -}}
              d16f0583616885423826241164ce1f6589c6fe5332fa74f374ebd2bd3cb3fe1f
            {{- else if and (eq OS "darwin") (eq ARCH "arm64") -}}
              db10dbbb42b110c7a5da5a3202908f32ad2ca6ad600d423426dc7886d09aad07
            {{- else -}}
              unsupported
            {{- end }}
          INCLUDE_PATTERNS: ["ct"]
          NUM_COMPONENTS_TO_STRIP: "0"
      - |-
        export PATH="{{.G_HELM_TOOLCHAIN_DIR}}:$PATH"
        export HELM_INSTALL_DIR="{{.G_HELM_TOOLCHAIN_DIR}}"
        curl --proto "=https" --tlsv1.2 --silent --show-error --fail \
        https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4 | bash -s -- --no-sudo

      # Create an environment file to configure the custom Helm toolchain location.
      - |-
        cat <<EOF > "{{.G_HELM_TOOLCHAIN_ENV_FILE}}"
        #!/bin/sh
        export PATH="{{.G_HELM_TOOLCHAIN_DIR}}:$PATH"
        EOF
        chmod +x "{{.G_HELM_TOOLCHAIN_ENV_FILE}}"

  rust:
    run: "once"
    cmds:
      # Installs Rust toolchains using rustup. If the toolchains are already installed, this task
      # will ensure they are updated to the latest versions.
      - |-
        curl --proto "=https" --tlsv1.2 --silent --show-error --fail https://sh.rustup.rs \
          | sh -s -- --default-toolchain none -y
        . "$HOME/.cargo/env"
        rustup toolchain install nightly --allow-downgrade --component clippy,rustfmt

version: "3"

includes:
  utils: "../tools/yscope-dev-utils/exports/taskfiles/utils/utils.yaml"

vars:
  G_RUST_TOOLCHAIN_ROOT: "{{.G_BUILD_DIR}}/toolchains/rust"

  # Rust toolchain paths
  G_CARGO_HOME: "{{.G_RUST_TOOLCHAIN_ROOT}}/.cargo"
  G_RUSTUP_HOME: "{{.G_RUST_TOOLCHAIN_ROOT}}/.rustup"

  # Rust toolchain environment
  G_CARGO_ENV: "{{.G_CARGO_HOME}}/env"

  # Rust toolchain checksum file
  G_RUST_TOOLCHAIN_CHECKSUM_FILE: "{{.G_BUILD_DIR}}/toolchain-rust.md5"

  G_RUST_ENV_FILE: "{{.G_RUST_TOOLCHAIN_ROOT}}/rust.env"

tasks:
  rust:
    run: "once"
    env:
      RUSTUP_HOME: "{{.G_RUSTUP_HOME}}"
      CARGO_HOME: "{{.G_CARGO_HOME}}"
    vars:
      CHECKSUM_FILE: "{{.G_RUST_TOOLCHAIN_CHECKSUM_FILE}}"
      OUTPUT_DIR: "{{.G_RUST_TOOLCHAIN_ROOT}}"
    sources:
      - "{{.ROOT_DIR}}/taskfile.yaml"
      - "{{.TASKFILE}}"
    generates: ["{{.CHECKSUM_FILE}}"]
    deps:
      - task: "utils:checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
    cmds:
      - |-
        curl --proto "=https" --tlsv1.2 --silent --show-error --fail https://sh.rustup.rs \
          | sh -s -- --default-toolchain none -y
        cat > {{.G_RUST_ENV_FILE}} << 'EOF'
        #!/bin/sh
        export RUSTUP_HOME={{.G_RUSTUP_HOME}}
        export CARGO_HOME={{.G_CARGO_HOME}}
        source {{.G_CARGO_ENV}}
        EOF
        chmod +x {{.G_RUST_ENV_FILE}}
        . {{.G_RUST_ENV_FILE}}
        rustup default stable
        cargo install cargo-nextest
      # This command must be last
      - task: "utils:checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]

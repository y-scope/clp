version: "3"

vars:
  # NOTE: This must be kept in-sync with its usage in components/core/CMakeLists.txt
  G_DEPS_CPP_CORE_CMAKE_SETTINGS_DIR: "{{.G_DEPS_CPP_DIR}}/cmake-settings/core"
  G_DEPS_CPP_CORE_CMAKE_SETTINGS_FILE: "{{.G_DEPS_CPP_CORE_CMAKE_SETTINGS_DIR}}/all-core.cmake"

tasks:
  default:
    deps:
      - task: "core"

  core:
    deps:
      - task: ":init"
      - task: ":utils:clean-outdated-cpp-checksum-files"
    cmds:
      - task: ":yscope-dev-utils:cmake:install-deps-and-generate-settings"
        vars:
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CPP_CORE_CMAKE_SETTINGS_DIR}}"
          CMAKE_SETTINGS_FILE: "{{.G_DEPS_CPP_CORE_CMAKE_SETTINGS_FILE}}"
          DEP_TASK: "core:core-all-parallel"
      - task: ":utils:combine-cpp-checksum-files"

  core-all-parallel:
    internal: true
    vars:
      CPP_CORE_TASKS:
        - "absl"
        - "antlr-jar"
        - "antlr-runtime"
        - "boost"
        - "catch2"
        - "date"
        - "fmt"
        - "liblzma"
        - "log-surgeon"
        - "lz4"
        - "microsoft.gsl"
        - "mongocxx"
        - "msgpack-cxx"
        - "nlohmann_json"
        - "simdjson"
        - "spdlog"
        - "sqlite3"
        - "utfcpp"
        - "yaml-cpp"
        - "ystdlib"
        - "zlib"
        - "zstd"
    run: "once"
    deps:
      - for:
          var: "CPP_CORE_TASKS"
        task: ":{{.ITEM}}"
        vars:
          CMAKE_SETTINGS_DIR: "{{.CMAKE_SETTINGS_DIR}}"

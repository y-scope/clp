version: "3"

vars:
  G_INTEGRATION_TESTS_DIR: "{{.ROOT_DIR}}/integration-tests"

tasks:
  default:
    deps:
      - task: "clp-py-project-imports"
      - task: "core"
      - task: "package"

  cache-clear:
    dir: "{{.G_INTEGRATION_TESTS_DIR}}"
    cmds:
      - "rm -rf .pytest_cache"

  core:
    env:
      CLP_BUILD_DIR: "{{.G_BUILD_DIR}}"
      CLP_CORE_BINS_DIR: "{{.G_CORE_COMPONENT_BUILD_DIR}}"
      CLP_PACKAGE_DIR: "{{.G_PACKAGE_BUILD_DIR}}"
    dir: "{{.G_INTEGRATION_TESTS_DIR}}"
    deps: ["::core"]
    cmd: "uv run pytest -m core"

  clp-py-project-imports:
    dir: "{{.G_INTEGRATION_TESTS_DIR}}"
    cmd: "uv run pytest tests/test_clp_native_py_project_imports.py"

  package:
    env:
      CLP_BUILD_DIR: "{{.G_BUILD_DIR}}"
      CLP_CORE_BINS_DIR: "{{.G_CORE_COMPONENT_BUILD_DIR}}"
      CLP_PACKAGE_DIR: "{{.G_PACKAGE_BUILD_DIR}}"
    dir: "{{.G_INTEGRATION_TESTS_DIR}}"
    deps: ["::package"]
    cmd: "uv run pytest -m package"

  python-wheels-yscope-clp-core:
    env:
      CLP_BUILD_DIR: "{{.G_BUILD_DIR}}"
    dir: "{{.G_INTEGRATION_TESTS_DIR}}"
    deps: ["::python-wheels-yscope-clp-core"]
    cmd: |-
      uv pip install --force-reinstall {{.G_PYTHON_WHEELS_BUILD_DIR}}/yscope_clp_core-*.whl
      uv run pytest -m yscope_clp_core

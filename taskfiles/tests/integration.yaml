version: "3"

vars:
  G_INTEGRATION_TESTS_DIR: "{{.ROOT_DIR}}/integration-tests"

tasks:
  default:
    deps:
      - task: "core"

  cache-clear:
    dir: "{{.G_INTEGRATION_TESTS_DIR}}"
    cmds:
      - >-
        uv run python -m pytest --cache-clear --collect-only --override-ini addopts="" --quiet
        > /dev/null

  core:
    deps:
      # TODO: https://github.com/y-scope/clp/issues/1281
      - task: "::package"
    dir: "{{.G_INTEGRATION_TESTS_DIR}}"
    env:
      CLP_BUILD_DIR: "{{.G_BUILD_DIR}}"
      CLP_CORE_BINS_DIR: "{{.G_CORE_COMPONENT_BUILD_DIR}}"
      CLP_DEPS_CORE_DIR: "{{.G_DEPS_CORE_DIR}}"
      CLP_LIBLZMA_ROOT: "{{.G_LIBLZMA_STATIC_INSTALL_PREFIX}}"
      CLP_LZ4_ROOT: "{{.G_LZ4_INSTALL_PREFIX}}"
      CLP_PACKAGE_DIR: "{{.G_PACKAGE_BUILD_DIR}}"
      CLP_ZSTD_ROOT: "{{.G_ZSTD_INSTALL_PREFIX}}"
    cmd: "uv run python -m pytest -m core"

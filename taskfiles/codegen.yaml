version: "3"

includes:
  toolchains: "toolchains.yaml"

tasks:
  clp-s-generate-parsers:
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK}}.md5"
      OUTPUT_DIRS:
        - "{{.G_CORE_COMPONENT_DIR}}/src/clp_s/search/kql/generated"
        - "{{.G_CORE_COMPONENT_DIR}}/src/clp_s/search/sql/generated"
    deps:
      - ":deps:antlr-jar"
      - task: ":utils:checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS:
            ref: ".OUTPUT_DIRS"
    generates: ["{{.CHECKSUM_FILE}}"]
    sources:
      - "{{.G_CORE_COMPONENT_DIR}}/src/clp_s/search/kql/Kql.g4"
      - "{{.G_CORE_COMPONENT_DIR}}/src/clp_s/search/sql/Sql.g4"
      - "{{.TASKFILE}}"
      - "{{.ROOT_TASKFILE}}"
    dir: "{{.G_CORE_COMPONENT_DIR}}/src/"
    cmds:
      - for: ["kql", "sql"]
        cmd: |-
          rm -rf "{{.G_CORE_COMPONENT_DIR}}/src/clp_s/search/{{.ITEM}}/generated/"* \
          && java -jar {{.G_ANTLR_JAR_FILE}} \
            -Dlanguage=Cpp \
            -no-listener \
            -visitor \
            -package clp_s::search::{{.ITEM}}::generated \
            -o clp_s/search/{{.ITEM}}/generated \
            -Xexact-output-dir \
            clp_s/search/{{.ITEM}}/*.g4 \
            && find "{{.G_CORE_COMPONENT_DIR}}/src/clp_s/search/{{.ITEM}}/generated" \
              -type f -and -not \( -name "*.cpp" -o -name "*.h" \) \
              -exec rm {} \;
      # This command must be last
      - task: ":utils:checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS:
            ref: ".OUTPUT_DIRS"

  webui-generate-parser:
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK}}.md5"
      SRC_DIR: "{{.G_WEBUI_SRC_DIR}}/client/src/sql-parser"
      OUTPUT_DIR: "{{.G_WEBUI_SRC_DIR}}/client/src/sql-parser/generated"
    deps:
      - ":deps:antlr-jar"
      - task: ":utils:checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
    generates: ["{{.CHECKSUM_FILE}}"]
    sources:
      - "{{.ROOT_TASKFILE}}"
      - "{{.SRC_DIR}}/SqlBase.g4"
      - "{{.SRC_DIR}}/Sql.g4"
      - "{{.TASKFILE}}"
    dir: "{{.SRC_DIR}}"
    cmds:
      - "rm -rf '{{.OUTPUT_DIR}}'"
      - >-
        java -jar {{.G_ANTLR_JAR_FILE}}
        -Dlanguage=TypeScript
        -no-listener
        -o generated
        -Xexact-output-dir Sql.g4
      - >-
        find generated
        -type f -and -not -name "*.ts"
        -exec rm {} \;
      - for:
          - "generated/SqlLexer.ts"
          - "generated/SqlParser.ts"
        task: ":utils:misc:replace-text"
        vars:
          FILE_PATH: "{{.SRC_DIR}}/{{.ITEM}}"
          SED_EXP: >-
            1s/^/\\/\\/ @ts-nocheck\\n/
      # This command must be last
      - task: ":utils:checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]

  openapi:
    deps: ["toolchains:rust"]
    dir: "{{.ROOT_DIR}}"
    cmd: |-
      . "{{.G_RUST_TOOLCHAIN_ENV_FILE}}"
      cargo run --bin api-server-openapi-codegen --release \
        -- "{{.G_DOCS_SRC_STATIC_GENERATED_DIR}}/api-server-openapi.json"
      cargo run --bin log-ingestor-openapi-codegen --release \
        -- "{{.G_DOCS_SRC_STATIC_GENERATED_DIR}}/log-ingestor-openapi.json"

name: "clp-package-all"

# Common service defaults.
x-service-defaults: &service_defaults
  image: "${CLP_PACKAGE_CONTAINER_IMAGE_REF:-clp-package}"
  logging:
    driver: "local"
  stop_grace_period: "60s"
  user: "${CLP_FIRST_PARTY_SERVICE_UID_GID:-1000:1000}"

# First-party service defaults with fluentd logging driver.
# Services using this will forward logs to Fluent Bit via Docker's fluentd driver.
x-first-party-service-defaults: &first_party_service_defaults
  <<: *service_defaults
  logging:
    driver: "fluentd"
    options:
      fluentd-address: "localhost:24224"
      fluentd-async: "true"
      fluentd-retry-wait: "1s"
      fluentd-max-retries: "3"

# Common healthcheck defaults.
x-healthcheck-defaults: &healthcheck_defaults
  # Avoid lowering to prevent excessive resource usage.
  interval: "30s"

  # Mark unhealthy after 3 failed probes.
  # - In steady state, (<interval> + <timeout>) Ã— 3 = ~90s before the service is marked unhealthy.
  # - From startup, <start_period> (60s) + ~90s = ~150s before the service is marked unhealthy.
  retries: 3

  # Frequent checks during startup allow fast transition to healthy.
  start_interval: "2s"

  # Ignore failures for <start_period> / (<start_interval> + <timeout>) = ~15 frequent checks before
  # counting retries.
  start_period: "60s"

  # Short timeout since no remote communication is expected.
  timeout: "2s"

# Common volume definitions.
x-volume-definitions:
  clp-config-readonly: &volume_clp_config_readonly
    type: "bind"
    source: "${CLP_LOGS_DIR_HOST:-./var/log}/.clp-config.yaml"
    target: "/etc/clp-config.yaml"
    read_only: true
  clp-logs: &volume_clp_logs
    type: "bind"
    source: "${CLP_LOGS_DIR_HOST:-./var/log}"
    target: "/var/log"
  clp-tmp: &volume_clp_tmp
    type: "bind"
    source: "${CLP_TMP_DIR_HOST:-./var/tmp}"
    target: "/var/tmp"

services:
  database:
    <<: *service_defaults
    image: "${CLP_DB_CONTAINER_IMAGE_REF:-mariadb:10-jammy}"
    hostname: "database"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable the database.
      replicas: "${CLP_DATABASE_ENABLED:-1}"
    user: "${CLP_THIRD_PARTY_SERVICE_UID_GID:-1000:1000}"
    environment:
      MYSQL_DATABASE: "${CLP_DB_NAME:-clp-db}"
      MYSQL_PASSWORD: "${CLP_DB_PASS:?Please set a value.}"
      MYSQL_ROOT_PASSWORD: "${CLP_DB_ROOT_PASS:?Please set a value.}"
      MYSQL_USER: "${CLP_DB_USER:?Please set a value.}"
    ports:
      - host_ip: "${CLP_DB_HOST:-127.0.0.1}"
        published: "${CLP_DB_PORT:-3306}"
        target: 3306
    volumes:
      - type: "bind"
        source: "${CLP_DB_CONF_LOGGING_FILE_HOST:-./etc/mysql/conf.d/logging.cnf}"
        target: "/etc/mysql/conf.d/logging.cnf"
        read_only: true
      - type: "bind"
        source: "${CLP_DB_DATA_DIR_HOST:-./var/data/database}"
        target: "/var/lib/mysql"
      - type: "bind"
        source: "${CLP_DB_LOGS_DIR_HOST:-./var/log/database}"
        target: "/var/log/mysql"
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "mysqladmin", "ping",
        "--silent",
        "-h", "127.0.0.1",
        "-u", "${CLP_DB_USER:?Please set a value.}",
        "--password=${CLP_DB_PASS:?Please set a value.}"
      ]

  db-table-creator:
    <<: *service_defaults
    hostname: "db_table_creator"
    environment:
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_ROOT_PASS: "${CLP_DB_ROOT_PASS:?Please set a value.}"
      CLP_DB_ROOT_USER: "${CLP_DB_ROOT_USER:-root}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
      SPIDER_DB_PASS: "${SPIDER_DB_PASS:?Please set a value.}"
      SPIDER_DB_USER: "${SPIDER_DB_USER:?Please set a value.}"
    volumes:
      - *volume_clp_config_readonly
    depends_on:
      database:
        condition: "service_healthy"
    command: [
      "python3",
      "-u",
      "-m", "clp_py_utils.create-db-tables",
      "--config", "/etc/clp-config.yaml",
      "--storage-engine", "${CLP_PACKAGE_STORAGE_ENGINE:-clp}",
    ]

  queue:
    <<: *service_defaults
    image: "rabbitmq:3.9.8"
    hostname: "queue"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable the queue.
      replicas: "${CLP_QUEUE_ENABLED:-1}"
    user: "${CLP_THIRD_PARTY_SERVICE_UID_GID:-1000:1000}"
    environment:
      RABBITMQ_DEFAULT_PASS: "${CLP_QUEUE_PASS:?Please set a value.}"
      RABBITMQ_DEFAULT_USER: "${CLP_QUEUE_USER:?Please set a value.}"
      RABBITMQ_LOGS: "/var/log/rabbitmq/rabbitmq.log"
    ports:
      - host_ip: "${CLP_QUEUE_HOST:-127.0.0.1}"
        published: "${CLP_QUEUE_PORT:-5672}"
        target: 5672
    volumes:
      - type: "bind"
        source: "${CLP_QUEUE_LOGS_DIR_HOST:-./var/log/queue}"
        target: "/var/log/rabbitmq"
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "rabbitmq-diagnostics", "check_running"
      ]

  redis:
    <<: *service_defaults
    image: "redis:7.2.4"
    hostname: "redis"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable the redis.
      replicas: "${CLP_REDIS_ENABLED:-1}"
    user: "${CLP_THIRD_PARTY_SERVICE_UID_GID:-1000:1000}"
    ports:
      - host_ip: "${CLP_REDIS_HOST:-127.0.0.1}"
        published: "${CLP_REDIS_PORT:-6379}"
        target: 6379
    volumes:
      - type: "bind"
        source: "${CLP_REDIS_CONF_FILE_HOST:-./etc/redis/redis.conf}"
        target: "/etc/redis/redis.conf"
        read_only: true
      - type: "bind"
        source: "${CLP_REDIS_DATA_DIR_HOST:-./var/data/redis}"
        target: "/data"
      - type: "bind"
        source: "${CLP_REDIS_LOGS_DIR_HOST:-./var/log/redis}"
        target: "/var/log/redis"
    command: [
      "redis-server",
      "/etc/redis/redis.conf",
      "--requirepass", "${CLP_REDIS_PASS:?Please set a value.}"
    ]
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "redis-cli",
        "-h", "127.0.0.1",
        "-p", "6379",
        "-a", "${CLP_REDIS_PASS:?Please set a value.}",
        "PING"
      ]

  results-cache:
    <<: *service_defaults
    image: "mongo:7.0.1"
    hostname: "results_cache"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable the results cache.
      replicas: "${CLP_RESULTS_CACHE_ENABLED:-1}"
    user: "${CLP_THIRD_PARTY_SERVICE_UID_GID:-1000:1000}"
    ports:
      - host_ip: "${CLP_RESULTS_CACHE_HOST:-127.0.0.1}"
        published: "${CLP_RESULTS_CACHE_PORT:-27017}"
        target: 27017
    volumes:
      - type: "bind"
        source: "${CLP_RESULTS_CACHE_CONF_FILE_HOST:-./etc/mongo/mongod.conf}"
        target: "/etc/mongo/mongod.conf"
        read_only: true
      - type: "bind"
        source: "${CLP_RESULTS_CACHE_DATA_DIR_HOST:-./var/data/results_cache}"
        target: "/data/db"
      - type: "bind"
        source: "${CLP_RESULTS_CACHE_LOGS_DIR_HOST:-./var/log/results_cache}"
        target: "/var/log/mongodb"
    command: [
      "--config", "/etc/mongo/mongod.conf",
      "--bind_ip", "0.0.0.0",
    ]
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD-SHELL",
        "echo 'db.runCommand(\"ping\").ok' | mongosh 127.0.0.1:27017/test --quiet"
      ]

  results-cache-indices-creator:
    <<: *service_defaults
    hostname: "results_cache_indices_creator"
    environment:
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
    depends_on:
      results-cache:
        condition: "service_healthy"
    command: [
      "python3",
      "-u",
      "-m", "clp_py_utils.initialize-results-cache",
      "--uri", "mongodb://results_cache:27017/${CLP_RESULTS_CACHE_DB_NAME:-clp-query-results}",
      "--stream-collection", "${CLP_RESULTS_CACHE_STREAM_COLLECTION_NAME:-stream-files}",
    ]

  spider-scheduler:
    <<: *service_defaults
    hostname: "spider_scheduler"
    environment:
      SPIDER_LOG_FILE: "/var/log/spider_scheduler.log"
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
    ports:
      - host_ip: "${SPIDER_SCHEDULER_HOST:-127.0.0.1}"
        published: "${SPIDER_SCHEDULER_PORT:-6000}"
        target: 6000
    command: [
      "/opt/clp/bin/spider_scheduler",
      "--host", "spider_scheduler",
      "--port", "6000",
      "--storage_url", "jdbc:mariadb://database:3306/\
        ${SPIDER_DB_NAME:-spider-db}?\
        user=${SPIDER_DB_USER:?Please set a value.}\
        &password=${SPIDER_DB_PASS:?Please set a value.}",
    ]

  compression-scheduler:
    <<: *first_party_service_defaults
    hostname: "compression_scheduler"
    stop_grace_period: "300s"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.compression-scheduler"
    environment:
      BROKER_URL: "amqp://${CLP_QUEUE_USER:?Please set a value.}\
        :${CLP_QUEUE_PASS:?Please set a value.}@queue:5672"
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      CLP_LOGGING_LEVEL: "${CLP_COMPRESSION_SCHEDULER_LOGGING_LEVEL:-INFO}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
      RESULT_BACKEND: "redis://default:${CLP_REDIS_PASS:?Please set a value.}@redis:6379\
        /${CLP_REDIS_BACKEND_DB_COMPRESSION:-1}"
    volumes:
      - *volume_clp_config_readonly
      - "${CLP_AWS_CONFIG_DIR_HOST:-empty}:/opt/clp/.aws:ro"
      - "${CLP_LOGS_INPUT_DIR_HOST:-empty}:${CLP_LOGS_INPUT_DIR_CONTAINER:-/mnt/logs}:ro"
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
      queue:
        condition: "service_healthy"
      redis:
        condition: "service_healthy"
    command: [
      "python3",
      "-u",
      "-m", "job_orchestration.scheduler.compress.compression_scheduler",
      "--config", "/etc/clp-config.yaml"
    ]

  compression-worker:
    <<: *first_party_service_defaults
    hostname: "compression_worker"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.compression-worker"
    environment:
      BROKER_URL: "amqp://${CLP_QUEUE_USER:?Please set a value.}\
        :${CLP_QUEUE_PASS:?Please set a value.}@queue:5672"
      CLP_CONFIG_PATH: "/etc/clp-config.yaml"
      CLP_HOME: "/opt/clp"
      CLP_LOGGING_LEVEL: "${CLP_COMPRESSION_WORKER_LOGGING_LEVEL:-INFO}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
      RESULT_BACKEND: "redis://default:${CLP_REDIS_PASS:?Please set a value.}@redis:6379\
        /${CLP_REDIS_BACKEND_DB_COMPRESSION:-1}"
    volumes:
      - *volume_clp_config_readonly
      - *volume_clp_tmp
      - "${CLP_ARCHIVE_OUTPUT_DIR_HOST:-empty}:/var/data/archives"
      - "${CLP_AWS_CONFIG_DIR_HOST:-empty}:/opt/clp/.aws:ro"
      - "${CLP_LOGS_INPUT_DIR_HOST:-empty}:${CLP_LOGS_INPUT_DIR_CONTAINER:-/mnt/logs}:ro"
      - "${CLP_STAGED_ARCHIVE_OUTPUT_DIR_HOST:-empty}:/var/data/staged-archives"
    command: [
      "python3",
      "-u",
      "/opt/clp/lib/python3/site-packages/bin/celery",
      "-A", "job_orchestration.executor.compress",
      "worker",
      "--concurrency", "${CLP_COMPRESSION_WORKER_CONCURRENCY:-1}",
      "--loglevel", "INFO",
      "-Q", "compression",
      "-n", "compression-worker"
    ]

  spider-compression-worker:
    <<: *first_party_service_defaults
    hostname: "compression_worker"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.spider-compression-worker"
    environment:
      CLP_CONFIG_PATH: "/etc/clp-config.yaml"
      CLP_HOME: "/opt/clp"
      CLP_LOGGING_LEVEL: "${CLP_COMPRESSION_WORKER_LOGGING_LEVEL:-INFO}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
    volumes:
      - *volume_clp_config_readonly
      - *volume_clp_tmp
      - "${CLP_ARCHIVE_OUTPUT_DIR_HOST:-empty}:/var/data/archives"
      - "${CLP_AWS_CONFIG_DIR_HOST:-empty}:/opt/clp/.aws:ro"
      - "${CLP_LOGS_INPUT_DIR_HOST:-empty}:${CLP_LOGS_INPUT_DIR_CONTAINER:-/mnt/logs}"
      - "${CLP_STAGED_ARCHIVE_OUTPUT_DIR_HOST:-empty}:/var/data/staged-archives"
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
    command: [
      "python3", "-u",
      "-m", "job_orchestration.executor.start-spider-worker",
      "--host", "compression_worker",
      "--num-workers", "${CLP_COMPRESSION_WORKER_CONCURRENCY:-1}",
      "--storage-url", "jdbc:mariadb://database:3306/\
        ${SPIDER_DB_NAME:-spider-db}?\
        user=${SPIDER_DB_USER:?Please set a value.}\
        &password=${SPIDER_DB_PASS:?Please set a value.}",
    ]

  webui:
    <<: *service_defaults
    hostname: "webui"
    environment:
      AWS_ACCESS_KEY_ID: "${CLP_STREAM_OUTPUT_AWS_ACCESS_KEY_ID:-}"
      AWS_SECRET_ACCESS_KEY: "${CLP_STREAM_OUTPUT_AWS_SECRET_ACCESS_KEY:-}"
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      HOST: "0.0.0.0"
      NODE_ENV: "production"
      NODE_PATH: "/opt/clp/var/www/webui/server/node_modules"
      PORT: "4000"
      RATE_LIMIT: "${CLP_WEBUI_RATE_LIMIT:-1000}"
    ports:
      - host_ip: "${CLP_WEBUI_HOST:-127.0.0.1}"
        published: "${CLP_WEBUI_PORT:-4000}"
        target: 4000
    volumes:
      - "${CLP_AWS_CONFIG_DIR_HOST:-empty}:/opt/clp/.aws:ro"
      - "${CLP_LOGS_INPUT_DIR_HOST:-empty}:${CLP_LOGS_INPUT_DIR_CONTAINER:-/mnt/logs}:ro"
      - "${CLP_STREAM_OUTPUT_DIR_HOST:-empty}:/var/data/streams:ro"
      - type: "bind"
        source: "./var/log"
        target: "/var/log/clp"
        read_only: true
      - type: "bind"
        source: "./var/www/webui/client/settings.json"
        target: "/opt/clp/var/www/webui/client/settings.json"
        read_only: true
      - type: "bind"
        source: "./var/www/webui/server/dist/settings.json"
        target: "/opt/clp/var/www/webui/server/dist/settings.json"
        read_only: true
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
      results-cache-indices-creator:
        condition: "service_completed_successfully"
    command: [
      "/opt/clp/bin/node-22",
      "/opt/clp/var/www/webui/server/dist/src/main.js"
    ]
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "bash",
        "-c",
        "< /dev/tcp/webui/4000"
      ]

  garbage-collector:
    <<: *first_party_service_defaults
    hostname: "garbage_collector"
    stop_grace_period: "10s"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable the garbage collector.
      replicas: "${CLP_GARBAGE_COLLECTOR_ENABLED:-1}"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.garbage-collector"
    environment:
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      CLP_HOME: "/opt/clp"
      CLP_LOGGING_LEVEL: "${CLP_GARBAGE_COLLECTOR_LOGGING_LEVEL:-INFO}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
    volumes:
      - *volume_clp_config_readonly
      - "${CLP_ARCHIVE_OUTPUT_DIR_HOST:-empty}:/var/data/archives"
      - "${CLP_AWS_CONFIG_DIR_HOST:-empty}:/opt/clp/.aws:ro"
      - "${CLP_STREAM_OUTPUT_DIR_HOST:-empty}:/var/data/streams"
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
      results-cache-indices-creator:
        condition: "service_completed_successfully"
    command: [
      "python3", "-u",
      "-m", "job_orchestration.garbage_collector.garbage_collector",
      "--config", "/etc/clp-config.yaml",
    ]

  query-scheduler:
    <<: *first_party_service_defaults
    hostname: "query_scheduler"
    stop_grace_period: "10s"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.query-scheduler"
    environment:
      BROKER_URL: "amqp://${CLP_QUEUE_USER:?Please set a value.}\
        :${CLP_QUEUE_PASS:?Please set a value.}@queue:5672"
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      CLP_LOGGING_LEVEL: "${CLP_QUERY_SCHEDULER_LOGGING_LEVEL:-INFO}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
      RESULT_BACKEND: "redis://default:${CLP_REDIS_PASS:?Please set a value.}@redis:6379\
        /${CLP_REDIS_BACKEND_DB_QUERY:-0}"
    volumes:
      - *volume_clp_config_readonly
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
      queue:
        condition: "service_healthy"
      redis:
        condition: "service_healthy"
    command: [
      "python3",
      "-u",
      "-m", "job_orchestration.scheduler.query.query_scheduler",
      "--config", "/etc/clp-config.yaml"
    ]
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "bash",
        "-c",
        "< /dev/tcp/query_scheduler/7000"
      ]

  query-worker:
    <<: *first_party_service_defaults
    hostname: "query_worker"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.query-worker"
    environment:
      BROKER_URL: "amqp://${CLP_QUEUE_USER:?Please set a value.}\
        :${CLP_QUEUE_PASS:?Please set a value.}@queue:5672"
      CLP_CONFIG_PATH: "/etc/clp-config.yaml"
      CLP_HOME: "/opt/clp"
      CLP_LOGGING_LEVEL: "${CLP_QUERY_WORKER_LOGGING_LEVEL:-INFO}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
      RESULT_BACKEND: "redis://default:${CLP_REDIS_PASS:?Please set a value.}@redis:6379\
        /${CLP_REDIS_BACKEND_DB_QUERY:-0}"
    volumes:
      - *volume_clp_config_readonly
      - "${CLP_ARCHIVE_OUTPUT_DIR_HOST:-empty}:/var/data/archives:ro"
      - "${CLP_AWS_CONFIG_DIR_HOST:-empty}:/opt/clp/.aws:ro"
      - "${CLP_STAGED_STREAM_OUTPUT_DIR_HOST:-empty}:/var/data/staged-streams"
      - "${CLP_STREAM_OUTPUT_DIR_HOST:-empty}:/var/data/streams"
    command: [
      "python3",
      "-u",
      "/opt/clp/lib/python3/site-packages/bin/celery",
      "-A", "job_orchestration.executor.query",
      "worker",
      "--concurrency", "${CLP_QUERY_WORKER_CONCURRENCY:-1}",
      "--loglevel", "INFO",
      "-Q", "query",
      "-n", "query-worker"
    ]

  reducer:
    <<: *first_party_service_defaults
    hostname: "reducer"
    stop_grace_period: "10s"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.reducer"
    environment:
      CLP_HOME: "/opt/clp"
      CLP_LOGGING_LEVEL: "${CLP_REDUCER_LOGGING_LEVEL:-INFO}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
    volumes:
      - *volume_clp_config_readonly
    depends_on:
      query-scheduler:
        condition: "service_healthy"
      results-cache-indices-creator:
        condition: "service_completed_successfully"
    command: [
      "python3", "-u",
      "-m", "job_orchestration.reducer.reducer",
      "--config", "/etc/clp-config.yaml",
      "--concurrency", "${CLP_REDUCER_CONCURRENCY:-1}",
      "--upsert-interval", "${CLP_REDUCER_UPSERT_INTERVAL:-100}"
    ]

  mcp-server:
    <<: *first_party_service_defaults
    hostname: "mcp_server"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable the MCP server.
      replicas: "${CLP_MCP_SERVER_ENABLED:-0}"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.mcp-server"
    environment:
      CLP_LOGGING_LEVEL: "${CLP_MCP_LOGGING_LEVEL:-INFO}"
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      PYTHONPATH: "/opt/clp/lib/python3/site-packages"
    ports:
      - host_ip: "${CLP_MCP_HOST:-127.0.0.1}"
        published: "${CLP_MCP_PORT:-8000}"
        target: 8000
    volumes:
      - *volume_clp_config_readonly
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
      results-cache-indices-creator:
        condition: "service_completed_successfully"
    command: [
      "python3", "-u",
      "-m", "clp_mcp_server.clp_mcp_server",
      "--host", "mcp_server",
      "--port", "8000",
      "--config-path", "/etc/clp-config.yaml",
    ]
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "curl",
        "-f",
        "http://mcp_server:8000/health"
      ]

  api-server:
    <<: *first_party_service_defaults
    hostname: "api_server"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable the API server.
      replicas: "${CLP_API_SERVER_ENABLED:-1}"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.api-server"
    environment:
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      RUST_LOG: "INFO"
    ports:
      - host_ip: "${CLP_API_SERVER_HOST:-127.0.0.1}"
        published: "${CLP_API_SERVER_PORT:-3001}"
        target: 3001
    volumes:
      - *volume_clp_config_readonly
      - "${CLP_STAGED_STREAM_OUTPUT_DIR_HOST:-empty}:/var/data/staged-streams"
      - "${CLP_STREAM_OUTPUT_DIR_HOST:-empty}:/var/data/streams"
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
      results-cache-indices-creator:
        condition: "service_completed_successfully"
    command: [
      "/opt/clp/bin/api_server",
      "--host", "0.0.0.0",
      "--port", "3001",
      "--config", "/etc/clp-config.yaml"
    ]
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "curl",
        "-f",
        "http://api_server:3001/health"
      ]

  log-ingestor:
    <<: *first_party_service_defaults
    hostname: "log_ingestor"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable log-ingestor.
      replicas: "${CLP_LOG_INGESTOR_ENABLED:-1}"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        fluentd-async: "true"
        tag: "clp.log-ingestor"
    environment:
      CLP_DB_PASS: "${CLP_DB_PASS:?Please set a value.}"
      CLP_DB_USER: "${CLP_DB_USER:?Please set a value.}"
      RUST_LOG: "${CLP_LOG_INGESTOR_LOGGING_LEVEL:-INFO}"
    ports:
      - host_ip: "${CLP_LOG_INGESTOR_HOST:-127.0.0.1}"
        published: "${CLP_LOG_INGESTOR_PORT:-3002}"
        target: 3002
    volumes:
      - *volume_clp_config_readonly
    depends_on:
      db-table-creator:
        condition: "service_completed_successfully"
    command: [
      "/opt/clp/bin/log-ingestor",
      "--config", "/etc/clp-config.yaml",
      "--host", "0.0.0.0",
      "--port", "3002"
    ]
    healthcheck:
      <<: *healthcheck_defaults
      test: [
        "CMD",
        "curl",
        "-f",
        "http://log_ingestor:3002/health"
      ]

  # Fluent Bit for centralized operational logging.
  # Receives logs from all CLP services via Docker's fluentd logging driver.
  # Writes logs to organized file storage for hot tier access.
  # Optionally uploads to S3 for archival (cold tier).
  fluent-bit:
    image: "${CLP_FLUENT_BIT_IMAGE:-fluent/fluent-bit:3.2}"
    hostname: "fluent_bit"
    deploy:
      # Value must be either 0 or 1. Set to 0 to disable Fluent Bit.
      replicas: "${CLP_FLUENT_BIT_ENABLED:-1}"
    logging:
      driver: "local"
    user: "0:0"
    ports:
      # HTTP monitoring endpoint
      - host_ip: "${CLP_FLUENT_BIT_HTTP_HOST:-127.0.0.1}"
        published: "${CLP_FLUENT_BIT_HTTP_PORT:-2020}"
        target: 2020
      # Forward protocol for receiving logs from Docker fluentd driver
      - host_ip: "${CLP_FLUENT_BIT_FORWARD_HOST:-0.0.0.0}"
        published: "${CLP_FLUENT_BIT_FORWARD_PORT:-24224}"
        target: 24224
    environment:
      FLUENT_BIT_LOG_LEVEL: "${CLP_FLUENT_BIT_LOG_LEVEL:-info}"
    volumes:
      - type: "bind"
        source: "${CLP_FLUENT_BIT_CONF_DIR_HOST:-./etc/fluent-bit}"
        target: "/fluent-bit/etc"
        read_only: true
      # Hot tier: Fluent Bit writes logs here for real-time access
      - type: "bind"
        source: "${CLP_LOGS_DIR_HOST:-./var/log}"
        target: "/var/log/clp"
      - "${CLP_AWS_CONFIG_DIR_HOST:-empty}:/root/.aws:ro"
    # Note: No healthcheck - fluent-bit distroless image doesn't have curl/wget.
    # Fluent Bit is a logging sidecar and doesn't need to be healthy for CLP to work.

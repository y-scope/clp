version: "3.9"

services:
  presto-coordinator:
    image: "ghcr.io/y-scope/presto/coordinator:dev"
    entrypoint: ["/bin/bash", "-c", "/scripts/generate-configs.sh && /opt/entrypoint.sh"]
    env_file:
      - ".env"
      - "coordinator-common.env"
      - "coordinator.env"
    volumes:
      - "./coordinator/scripts:/scripts:ro"
      - "coordinator-config:/opt/presto-server/etc"
      - "./coordinator/config-template:/configs:ro"
    networks:
      - "presto"
    healthcheck:
      test:
        - "CMD"
        - "curl"
        - "-f"
        - "${PRESTO_COORDINATOR_CONFIG_CONFIGPROPERTIES_DISCOVERY_URI}/v1/info"
      interval: "10s"
      retries: 30

  presto-worker:
    image: "ghcr.io/y-scope/presto/prestissimo-worker:dev"
    depends_on:
      presto-coordinator:
        condition: "service_healthy"
    entrypoint: ["/bin/bash", "-c", "/scripts/generate-configs.sh && /opt/entrypoint.sh"]
    env_file:
      - ".env"
      - "coordinator-common.env"
      - "worker.env"
    volumes:
      - "./worker/scripts:/scripts:ro"
      - "worker-config:/opt/presto-server/etc"
      - "./worker/config-template:/configs:ro"
      - "${CLP_PACKAGE_ARCHIVES}:${CLP_PACKAGE_ARCHIVES}"
    networks:
      - "presto"

volumes:
  coordinator-config:
  worker-config:

networks:
  presto:
    driver: "bridge"

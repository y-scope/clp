version: "3"
vars:
    DEP_DOWNLOAD_SCRIPT: "{{.ROOT_DIR}}/tools/scripts/download-dep.py"

tasks:
  default:
    deps: ["clp-submodules", "core-submodules"]

  clp-submodules:
    deps: ["yscope-log-viewer"]

  core-submodules:
    deps:

  yscope-log-viewer:
    internal: true
    deps:
      - ":init"
    cmds:
      - task: "download-dependency"
        vars:
          CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK}}.md5"
          SOURCE_URL: "https://github.com/y-scope/yscope-log-viewer/archive/df996ea.zip"
          SOURCE_NAME: "yscope-log-viewer-df996eac000823d02f9cd0b9eb4bb732dd634ae5"
          FLAGS: "--extract"
          DESTINATION: "{{.ROOT_DIR}}/component/log-viewer-webui/yscope-log-viewer"


  download-dependency:
    internal: true
    label: "{{.TASK}}-{{.TAR_NAME}}"
    requires:
      vars: ["CHECKSUM_FILE", "SOURCE_URL", "SOURCE_NAME", "DESTINATION", "FLAGS"]
    sources:
      - "{{.TASKFILE}}"
      - "{{.DEP_DOWNLOAD_SCRIPT}}"
    generates: ["{{.CHECKSUM_FILE}}"]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DESTINATION}}"
    cmds:
      - >-
        python3 "{{.DEP_DOWNLOAD_SCRIPT}}"
        '{{.ROOT_DIR}}'
        '{{.SOURCE_URL}}'
        '{{.SOURCE_NAME}}'
        '{{.DESTINATION}}'
        '{{.FLAGS}}'
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DESTINATION}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"
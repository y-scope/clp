version: "3"
vars:
    G_DEP_DOWNLOAD_SCRIPT: "{{.ROOT_DIR}}/tools/scripts/deps-download/download-dep.py"

tasks:
  default:
    cmds:
      - task: "core"
      - task: "log-viewer"

  core:
    cmds:
      - task: "abseil-cpp"
      - task: "antlr4"
      - task: "Catch2"
      - task: "date"
      - task: "json"
      - task: "log-surgeon"
      - task: "outcome"
      - task: "simdjson"
      - task: "sqlite3"
      - task: "yaml-cpp"

  log-viewer:
    cmds:
      - task: "yscope-log-viewer"

  abseil-cpp:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/abseil-cpp"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.ROOT_DIR}}/Taskfile.yml"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "abseil-cpp-20230802.1"
          SRC_URL: "https://github.com/abseil/abseil-cpp/archive/refs/tags/20230802.1.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  antlr4:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST_DIR: "{{.G_CORE_COMPONENT_DIR}}/third-party/antlr"
      DEST: "{{.DEST_DIR}}/antlr-4.13.1-complete.jar"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST_DIR}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--no-submodule"
          SRC_NAME: "antlr-4.13.1-complete.jar"
          SRC_URL: "https://www.antlr.org/download/antlr-4.13.1-complete.jar"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST_DIR}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  Catch2:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/Catch2"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "Catch2-2.13.7"
          SRC_URL: "https://github.com/catchorg/Catch2/archive/refs/tags/v2.13.7.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  date:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/date"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "date-3.0.1"
          SRC_URL: "https://github.com/HowardHinnant/date/archive/refs/tags/v3.0.1.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  json:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/json"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "json-3.11.3"
          SRC_URL: "https://github.com/nlohmann/json/archive/refs/tags/v3.11.3.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  log-surgeon:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/log-surgeon"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "log-surgeon-895f46489b1911ab3b3aac3202afd56c96e8cd98"
          SRC_URL: "https://github.com/y-scope/log-surgeon/archive/895f464.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  outcome:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/outcome"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "outcome-2.2.9"
          SRC_URL: "https://github.com/ned14/outcome/archive/refs/tags/v2.2.9.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  simdjson:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/simdjson"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "simdjson-3.6.3"
          SRC_URL: "https://github.com/simdjson/simdjson/archive/refs/tags/v3.6.3.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  # We don't use a git submodule for sqlite3 since that would require building the sqlite
  # amalgamation
  sqlite3:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/sqlite3"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract --no-submodule"
          SRC_NAME: "sqlite-amalgamation-3360000"
          SRC_URL: "https://www.sqlite.org/2021/sqlite-amalgamation-3360000.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  yaml-cpp:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_CORE_COMPONENT_SUBMODULES_DIR}}/yaml-cpp"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: ["{{.CHECKSUM_FILE}}"]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "yaml-cpp-yaml-cpp-0.7.0"
          SRC_URL: "https://github.com/jbeder/yaml-cpp/archive/refs/tags/yaml-cpp-0.7.0.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  yscope-log-viewer:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      DEST: "{{.G_LOG_VIEWER_WEBUI_SRC_DIR}}/yscope-log-viewer"
    sources:
      - "{{.G_DEP_DOWNLOAD_SCRIPT}}"
      - "{{.TASKFILE}}"
    generates: [ "{{.CHECKSUM_FILE}}" ]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.DEST}}"
    cmds:
      - task: "download-dependency"
        vars:
          DEST: "{{.DEST}}"
          FLAGS: "--extract"
          SRC_NAME: "yscope-log-viewer-df996eac000823d02f9cd0b9eb4bb732dd634ae5"
          SRC_URL: "https://github.com/y-scope/yscope-log-viewer/archive/df996ea.zip"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.DEST}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"

  download-dependency:
    internal: true
    label: "{{.TASK}}-{{.SRC_NAME}}"
    requires:
      vars: ["DEST", "FLAGS", "SRC_NAME", "SRC_URL"]
    deps:
      - ":init"
    cmds:
      - >-
        python3 "{{.G_DEP_DOWNLOAD_SCRIPT}}"
        "{{.SRC_URL}}"
        {{.SRC_NAME}}
        "{{.DEST}}"
        {{.FLAGS}}

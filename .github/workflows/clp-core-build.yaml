name: build-clp-core

on:
  push:
    branches: [ main ]
    paths:
      - 'components/core/**'
      - '.github/workflows/clp-core-build.yaml'
  pull_request:
    branches: [ main ]
    paths:
      - 'components/core/**'
      - '.github/workflows/clp-core-build.yaml'
  workflow_dispatch:
  workflow_run:
    workflows: ["generate-build-dependency-image"]
    branches: [main]
    types:
      - completed

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BASE: ${{github.repository}}/clp-core-x86

concurrency: build-${{github.ref}}

jobs:
  build-focal:
    runs-on: ubuntu-latest
    container: ghcr.io/y-scope/clp/clp-core-dependencies-x86-ubuntu-focal:main
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build CLP Core
        id: build
        uses: ./.github/actions/clp-core-build
        with:
          output_path: ${{github.workspace}}

      - name: Upload CLP Binary artifact
        uses: actions/upload-artifact@v2
        with:
          name: clp_binaries
          path: ${{github.workspace}}/clp_binaries.tar
  
  build-clp-core-image:
    needs: build-focal
    runs-on: ubuntu-latest
    steps:
      - name: Download built CLP Binaries
        uses: actions/download-artifact@v2
        with:
          name: clp_binaries
      
      - name: Extract Binaries Bundle
        run: tar -xf clp_binaries.tar

      - name: Build and Push Ubuntu Focal Docker Image
        uses: ./.github/actions/clp-docker-build-push-action
        with:
          image_name: ${{env.IMAGE_NAME_BASE}}-ubuntu-focal
          context: ./
          file: components/core/tools/docker-images/clp-core-focal/Dockerfile

      

  build-bionic:
    runs-on: ubuntu-latest
    container: ghcr.io/y-scope/clp/clp-core-dependencies-x86-ubuntu-bionic:main
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build CLP Core
        uses: ./.github/actions/clp-core-build

  build-centos:
    runs-on: ubuntu-latest
    container: ghcr.io/y-scope/clp/clp-core-dependencies-x86-centos7.4:main
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build CLP Core
        uses: ./.github/actions/clp-core-build
